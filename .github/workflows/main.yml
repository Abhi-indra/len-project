name: CI/CD Deploy via Bastion (Raw SSH + Debug)

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: lens

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BUILD & PUSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Checkout code
      uses: actions/checkout@v3

    # Short, reproducible image tag = first 8 chars of commit SHA
    - name: Export short SHA
      id: vars
      run: echo "tag=${GITHUB_SHA::8}" >> "$GITHUB_OUTPUT"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id:      ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region:             ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build Docker image
      run: |
        docker build \
          -t ${{ secrets.ECR_REPO }}:${{ steps.vars.outputs.tag }} \
          -t ${{ secrets.ECR_REPO }}:latest \
          -f application/Dockerfile application

    - name: Push Docker image to ECR
      run: |
        docker push ${{ secrets.ECR_REPO }}:${{ steps.vars.outputs.tag }}
        docker push ${{ secrets.ECR_REPO }}:latest

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DEPLOY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Deploy to Private EC2 via Bastion
      uses: appleboy/ssh-action@v1.0.0
      timeout: "120s"            # give the TCP handshake more time
      env:                       # all values needed INSIDE the script
        AWS_REGION: ${{ secrets.AWS_REGION }}
        ECR_REPO:   ${{ secrets.ECR_REPO }}
        BACKEND_IP: ${{ secrets.EC2_BACKEND }}
        USERNAME:   ${{ secrets.EC2_USER }}
        TAG:        ${{ steps.vars.outputs.tag }}
      with:
        host:     ${{ secrets.EC2_BASTION }}   # bastion public IP/DNS
        username: ${{ secrets.EC2_USER }}
        key:      ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -euo pipefail
          KEY=~/.ssh/lens.pem

          # 1) Ensure the key exists only once
          if [ ! -s "$KEY" ]; then
            echo "ðŸŸ¡ First run: writing $KEY"
            printf '%s\n' "${{ secrets.EC2_SSH_KEY }}" > "$KEY"
            chmod 400 "$KEY"
          else
            echo "ðŸŸ¡ $KEY already exists â€“ skipping"
          fi

          # 2) Quick network sanity check
          ip route
          ping -c3 "$BACKEND_IP" || true

          # 3) Hop from bastion â†’ backend and deploy
          ssh -o StrictHostKeyChecking=no -i "$KEY" "$USERNAME@$BACKEND_IP" bash -s -- <<EOF
            set -euo pipefail
            echo "ðŸŸ¢ On \$(hostname) as \$(whoami)"

            # Login to ECR
            aws ecr get-login-password --region "${AWS_REGION}" \
              | docker login --username AWS --password-stdin "${ECR_REPO}"

            # Pull the exact image; fall back to :latest if needed
            docker pull "${ECR_REPO}:${TAG}" || docker pull "${ECR_REPO}:latest"

            # Stop & remove any existing container
            docker stop app 2>/dev/null || true
            docker rm   app 2>/dev/null || true

            # Run the new container
            docker run -d --restart=always \
              --name app -p 5000:5000 "${ECR_REPO}:${TAG}"
          EOF
